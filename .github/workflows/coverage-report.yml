name: Coverage Report

on:
  workflow_run:
    workflows: ["Build and Test"]
    types:
      - completed

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  coverage-comment:
    name: Post Coverage Comment
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion == 'success'
    
    steps:
    - name: Download coverage artifact
      uses: actions/download-artifact@v4
      with:
        name: coverage-report
        path: ./coverage
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Get PR number
      id: pr
      run: |
        PR_NUMBER=$(gh api /repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }} --jq '.pull_requests[0].number')
        echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Read coverage summary
      id: coverage
      run: |
        if [ -f "./coverage/Summary.txt" ]; then
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          cat ./coverage/Summary.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "Coverage report not found"
          echo "summary=Coverage report not found" >> $GITHUB_OUTPUT
        fi
        
        if [ -f "./coverage/SummaryGithub.md" ]; then
          echo "markdown<<EOF" >> $GITHUB_OUTPUT
          cat ./coverage/SummaryGithub.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "markdown=" >> $GITHUB_OUTPUT
        fi

    - name: Post coverage comment
      if: steps.pr.outputs.pr_number != ''
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        number: ${{ steps.pr.outputs.pr_number }}
        header: coverage-report
        message: |
          ## ğŸ“Š Code Coverage Report
          
          ${{ steps.coverage.outputs.markdown }}
          
          <details>
          <summary>ğŸ“‹ Detailed Text Summary</summary>
          
          ```
          ${{ steps.coverage.outputs.summary }}
          ```
          
          </details>
          
          ğŸ“ **[View Full HTML Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})** (Download artifacts â†’ coverage-report)